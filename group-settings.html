<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Group Settings</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:16px}
    h1{margin:8px 0 16px}
    .card{max-width:560px;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0}
    .row{display:flex;gap:8px;align-items:center;margin:8px 0}
    input[type="text"]{flex:1;padding:10px;border:1px solid #ccc;border-radius:8px}
    button{padding:10px 14px;border:0;border-radius:8px;cursor:pointer}
    .primary{background:#2563eb;color:#fff}
    .danger{background:#ef4444;color:#fff}
    .muted{background:#f3f4f6}
    small{opacity:.7}
    .mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  </style>
</head>
<body>
  <div id="navbar-container"></div>
  <script type="module" src="./load-navbar.js?v=2025.01.09E"></script>

  <h1>Group Settings</h1>

  <div class="card">
    <h3>Invite people</h3>
    <div class="row">
      <label class="mono">Invite code:</label>
      <input id="inviteCode" type="text" readonly value="loading..."/>
      <button id="copyBtn" class="muted">Copy</button>
    </div>
    <small>Share this code with family. They can join from the form below.</small>
  </div>

  <div class="card">
    <h3>Join a group by code</h3>
    <div class="row">
      <input id="joinCode" type="text" placeholder="Paste invite code here"/>
      <button id="joinBtn" class="primary">Join Group</button>
    </div>
  </div>

  <div class="card">
    <h3>Leave this group</h3>
    <div class="row">
      <button id="leaveBtn" class="danger">Leave Current Group</button>
    </div>
  </div>

  <script type="module">
    import { rest, getSessionFromStorage } from './restClient.js?v=2025.01.09E';

    const GROUP_KEY = 'currentGroupId';
    const inviteCodeEl = document.getElementById('inviteCode');
    const copyBtn      = document.getElementById('copyBtn');
    const joinCodeEl   = document.getElementById('joinCode');
    const joinBtn      = document.getElementById('joinBtn');
    const leaveBtn     = document.getElementById('leaveBtn');

    const getActiveGroupId = () => localStorage.getItem(GROUP_KEY) || null;

    async function requireSession(){
      const session = getSessionFromStorage();
      if (!session?.user?.id) { alert('Please log in first.'); location.href = './login.html'; throw new Error('no session'); }
      return session;
    }

    async function loadInviteCode(){
      const gid = getActiveGroupId();
      if (!gid) { inviteCodeEl.value = 'no active group'; return; }
      try {
        const rows = await rest(`groups?id=eq.${encodeURIComponent(gid)}&select=join_code`);
        inviteCodeEl.value = rows?.[0]?.join_code || '(none)';
      } catch (error){
        console.error(error);
        inviteCodeEl.value='(error)';
      }
    }

    copyBtn.addEventListener('click', async () => {
      if (!inviteCodeEl.value || inviteCodeEl.value.includes('loading')) return;
      await navigator.clipboard.writeText(inviteCodeEl.value);
      copyBtn.textContent = 'Copied!';
      setTimeout(()=> copyBtn.textContent='Copy', 900);
    });

    joinBtn.addEventListener('click', async () => {
      const code = (joinCodeEl.value || '').trim();
      if (!code) return alert('Enter a code.');
      await requireSession();
      try {
        const rows = await rest('rpc/join_group', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ p_code: code }),
        });
        const newGroupId = rows?.[0]?.group_id;
        if (newGroupId) {
          localStorage.setItem(GROUP_KEY, newGroupId);
          window.loadGroupsIntoSwitcher?.();   // refresh navbar switcher if present
          alert('Joined group!');
          await loadInviteCode();
        }
      } catch (error) {
        console.error(error);
        alert(error?.message || 'Join failed');
      }
    });

    leaveBtn.addEventListener('click', async () => {
      const gid = getActiveGroupId();
      if (!gid) return alert('No active group.');
      if (!confirm('Leave this group?')) return;
      const session = getSessionFromStorage();
      if (!session?.user?.id) return alert('Please log in first.');
      try {
        await rest(`group_members?group_id=eq.${encodeURIComponent(gid)}&user_id=eq.${encodeURIComponent(session.user.id)}`, {
          method: 'DELETE',
          headers: { Prefer: 'return=minimal' },
        });
      } catch (error) {
        console.error(error);
        alert('Could not leave group.');
        return;
      }
      localStorage.removeItem(GROUP_KEY);
      window.loadGroupsIntoSwitcher?.();
      inviteCodeEl.value = 'no active group';
      alert('You left the group.');
    });

    (async () => {
      await requireSession();
      await loadInviteCode();
    })();
  </script>
  <script>
    (function(){
      const version = window.STAR_BUILD_VERSION || '2025.01.09E';
      if (!window.STAR_BUILD_VERSION) window.STAR_BUILD_VERSION = version;
      const ensureBadge = () => {
        if (document.getElementById('star-build-version')) return;
        const badge = document.createElement('div');
        badge.id = 'star-build-version';
        badge.textContent = `Build ${version}`;
        badge.style.cssText = `
          position:fixed;
          right:12px;
          bottom:12px;
          background:rgba(17,17,17,0.85);
          color:#f9fafb;
          font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
          font-size:11px;
          font-weight:600;
          letter-spacing:0.02em;
          padding:6px 10px;
          border-radius:10px;
          box-shadow:0 6px 18px rgba(0,0,0,0.18);
          z-index:998;
          pointer-events:none;
        `;
        document.body.appendChild(badge);
      };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ensureBadge, { once: true });
      } else {
        ensureBadge();
      }
    })();
  </script>
</body>
</html>
