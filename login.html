<!-- login.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Login - STAR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #f9fafb; margin: 0; min-height: 100vh;
      display: grid; place-items: center;
    }
    .card {
      width: 340px; max-width: 92vw; background: #fff; padding: 24px 22px;
      border-radius: 14px; box-shadow: 0 6px 24px rgba(0,0,0,.08);
    }
    h1 { margin: 0 0 6px; font-size: 28px; }
    .tagline { margin: 0 0 18px; color: #6b7280; font-size: 13px; }
    label { display:block; font-size: 13px; margin: 10px 0 6px; color:#111827; }
    input {
      width: 100%; padding: 10px 12px; font-size: 15px;
      border: 1px solid #d1d5db; border-radius: 10px; outline: none;
    }
    .row { display:flex; gap:10px; margin-top: 14px; }
    button {
      flex: 1 1 auto; padding: 10px 14px; font-size: 15px; border: 0; border-radius: 10px;
      background:#111827; color:#fff; cursor:pointer;
    }
    button.ghost { background:#fff; color:#111827; border:1px solid #e5e7eb; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    #logoutBtn { width:100%; margin-top: 10px; display:none; }
    #message { min-height: 18px; margin-top: 10px; font-size: 13px; color:#b91c1c; }
    #message.ok { color:#0f766e; }
    .muted { color:#6b7280; font-size:12px; margin-top:10px }
  </style>
</head>
<body>
  <main class="card">
    <h1>ðŸŒŸ STAR</h1>
    <p class="tagline"><strong>Support Tool for Autonomy and Reflection</strong></p>

    <!-- Signed-out view -->
    <form id="authForm" novalidate>
      <label for="email">Email</label>
      <input id="email" type="email" autocomplete="username" placeholder="you@example.com" required />

      <label for="password">Password</label>
      <input id="password" type="password" autocomplete="current-password" placeholder="Your password" required />

      <div class="row">
        <button id="loginBtn" type="submit">Login</button>
        <button id="signupBtn" type="button" class="ghost">Sign up</button>
      </div>

      <button id="forgotBtn" type="button" class="ghost" style="margin-top:10px;">Forgot password?</button>
    </form>

    <!-- Signed-in view -->
    <button id="logoutBtn" type="button">Log Out</button>

    <div id="message" role="status" aria-live="polite"></div>
    <p class="muted" id="whoami"></p>
  </main>

  <!-- Auth logic -->
  <script type="module">
    import {
      SUPABASE_URL,
      SUPABASE_ANON_KEY,
      saveSession,
      clearSavedSession,
      getSessionFromStorage,
    } from './supabaseClient.js?v=2025.01.09E';
    import { rest } from './restClient.js?v=2025.01.09E';

    const params   = new URLSearchParams(location.search);
    const normalizeRedirect = (value) => {
      if (!value) return null;
      const trimmed = value.replace(/^\/+/, '').split('?')[0];
      return trimmed || null;
    };
    const ALLOWED_REDIRECTS = new Set([
      'profile.html',
      'dashboard.html',
      'home.html',
      'calendar.html',
      'caregiver-checkin.html',
      'caregiver-report.html',
      'chat.html',
      'mood-report.html',
      'moodchecker_with_other_moods.html',
      'wouldyourather.html',
      'focus-week.html',
      'documents/documents.html',
      'documents/minutes-form.html',
      'emergency-medical.html',
      'group-settings.html'
    ]);
    const rawRedirect = normalizeRedirect(params.get('redirect'));
    const redirect = ALLOWED_REDIRECTS.has(rawRedirect) ? rawRedirect : 'dashboard.html';

    const form      = document.getElementById('authForm');
    const emailEl   = document.getElementById('email');
    const passEl    = document.getElementById('password');
    const loginBtn  = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const forgotBtn = document.getElementById('forgotBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const msg       = document.getElementById('message');
    const whoami    = document.getElementById('whoami');

    const showMsg = (text, ok=false) => {
      msg.textContent = text || '';
      msg.classList.toggle('ok', !!ok);
    };
    const show = (el, on) => { if (el) el.style.display = on ? '' : 'none'; };
    const setBusy = (on) => { [loginBtn, signupBtn, forgotBtn, logoutBtn].forEach(b => b && (b.disabled = on)); };

    const authHeaders = (includeToken = false) => {
      const headers = {
        apikey: SUPABASE_ANON_KEY,
        'Content-Type': 'application/json',
      };
      if (includeToken) {
        const session = getSessionFromStorage();
        if (!session?.access_token) throw new Error('Not signed in');
        headers.Authorization = `Bearer ${session.access_token}`;
      }
      return headers;
    };

    const normalizeSession = (payload) => {
      if (!payload || typeof payload !== 'object') return null;
      if (payload.session) return payload.session;
      if (!payload.access_token) return null;
      return {
        access_token: payload.access_token,
        refresh_token: payload.refresh_token || null,
        expires_in: payload.expires_in ?? null,
        expires_at:
          payload.expires_at ??
          (payload.expires_in ? Math.floor(Date.now() / 1000) + Number(payload.expires_in || 0) : null),
        token_type: payload.token_type || 'bearer',
        user: payload.user ?? null,
      };
    };

    async function authRequest(path, { body, requireToken = false } = {}) {
      const res = await fetch(`${SUPABASE_URL}${path}`, {
        method: 'POST',
        headers: authHeaders(requireToken),
        body: body ? JSON.stringify(body) : undefined,
      });
      const text = await res.text();
      const payload = text ? JSON.parse(text) : null;
      if (!res.ok) {
        const message =
          payload?.error_description ||
          payload?.error ||
          payload?.message ||
          text ||
          'Auth request failed';
        throw new Error(message);
      }
      const session = normalizeSession(payload);
      if (session) saveSession(session);
      return payload;
    }

    async function ensureProfileRow(user) {
      if (!user?.id) return;
      const name =
        user.user_metadata?.full_name ||
        user.user_metadata?.name ||
        user.email;
      try {
        await rest('profiles', {
          method: 'POST',
          headers: { Prefer: 'resolution=merge-duplicates,return=minimal' },
          body: JSON.stringify([{
            id: user.id,
            full_name: name,
            public_name: name,
            display_name: name,
          }]),
        });
      } catch (error) {
        console.warn('[AUTH] ensureProfileRow failed', error);
      }
    }

    function currentSession() {
      return getSessionFromStorage();
    }

    async function render() {
      const session = currentSession();
      const authed = !!session?.user;
      show(form, !authed);
      show(logoutBtn, authed);
      whoami.textContent = authed ? `Signed in as ${session.user.email}` : '';
    }

    function loginInProgress() {
      const msgText = msg?.textContent || '';
      return msgText.includes('Retryingâ€¦');
    }

    async function handleLogin(email, password) {
      const payload = await authRequest('/auth/v1/token?grant_type=password', {
        body: { email, password },
      });
      const session = currentSession();
      if (session?.user) {
        await ensureProfileRow(session.user);
        try { localStorage.setItem('user_id', session.user.id); } catch {}
      }
      return payload;
    }

    async function handleSignup(email, password) {
      const payload = await authRequest('/auth/v1/signup', { body: { email, password } });
      const session = currentSession();
      if (session?.user) {
        await ensureProfileRow(session.user);
        try { localStorage.setItem('user_id', session.user.id); } catch {}
      }
      return payload;
    }

    async function handleReset(email) {
      await authRequest('/auth/v1/recover', { body: { email } });
    }

    async function handleLogout() {
      try {
        await authRequest('/auth/v1/logout', { body: { scope: 'global' }, requireToken: true });
      } catch (err) {
        console.warn('[AUTH] logout request failed', err);
      } finally {
        clearSavedSession();
        try { localStorage.removeItem('user_id'); } catch {}
        render();
      }
    }

    async function boot() {
      if (!form || !emailEl || !passEl) {
        console.error('[AUTH] Required form elements not found.');
        return;
      }

      setBusy(true);
      showMsg('Loadingâ€¦');

      try {
        showMsg('');
        render();

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          showMsg('');
          setBusy(true);

          try {
            const email = (emailEl.value || '').trim();
            const password = passEl.value;
            if (!email || !password) {
              showMsg('Enter email & password');
              setBusy(false);
              return;
            }

            await handleLogin(email, password);

            showMsg('Success! Redirectingâ€¦', true);
            setTimeout(() => {
              try {
                window.location.assign(redirect);
              } catch (navErr) {
                console.warn('[LOGIN] window.location.assign failed, fallback replace', navErr);
                window.location.href = redirect;
              }
            }, 120);
          } catch (err) {
            console.error('[LOGIN] error', err);
            showMsg(err.message || 'Unexpected error. See console.');
            if (!loginInProgress()) setBusy(false);
          }
        });

        signupBtn?.addEventListener('click', async () => {
          showMsg('');
          setBusy(true);
          try {
            const email = (emailEl.value || '').trim();
            const password = passEl.value;
            if (!email || !password) {
              showMsg('Enter email & password');
              return;
            }

            const result = await handleSignup(email, password);
            const hasSession = !!currentSession()?.user;
            if (hasSession) {
              location.replace(redirect);
            } else {
              showMsg('Check your email to confirm, then log in.', true);
            }
          } catch (err) {
            showMsg(err.message || 'Signup failed.');
          } finally {
            setBusy(false);
          }
        });

        forgotBtn?.addEventListener('click', async () => {
          const email = (emailEl.value || '').trim();
          if (!email) {
            showMsg('Enter your email first.');
            return;
          }
          setBusy(true);
          showMsg('Sending reset emailâ€¦');
          try {
            await handleReset(email);
            showMsg('Password reset email sent. Check your inbox (and spam).', true);
          } catch (err) {
            console.error('[AUTH] reset failed', err);
            showMsg(err.message || 'Could not send reset email. Try again shortly.');
          } finally {
            setBusy(false);
          }
        });

        logoutBtn?.addEventListener('click', async () => {
          showMsg('');
          setBusy(true);
          await handleLogout();
          showMsg('Logged out.', true);
          setBusy(false);
        });

        window.addEventListener('storage', render);
        render();
      } catch (initErr) {
        console.error('[AUTH] boot failed', initErr);
        showMsg('Could not initialize authentication. Refresh to retry.');
      } finally {
        setBusy(false);
      }
    }

    boot();
  </script>

  <script>
    (function(){
      const version = window.STAR_BUILD_VERSION || '2025.01.09E';
      if (!window.STAR_BUILD_VERSION) window.STAR_BUILD_VERSION = version;
      const ensureBadge = () => {
        if (document.getElementById('star-build-version')) return;
        const badge = document.createElement('div');
        badge.id = 'star-build-version';
        badge.textContent = `Build ${version}`;
        badge.style.cssText = `
          position:fixed;
          right:12px;
          bottom:calc(var(--tabbar-h,0px) + 12px);
          background:rgba(17,17,17,0.85);
          color:#f9fafb;
          font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
          font-size:11px;
          font-weight:600;
          letter-spacing:0.02em;
          padding:6px 10px;
          border-radius:10px;
          box-shadow:0 6px 18px rgba(0,0,0,0.18);
          z-index:998;
          pointer-events:none;
        `;
        document.body.appendChild(badge);
      };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ensureBadge, { once: true });
      } else {
        ensureBadge();
      }
    })();
  </script>

</body>
</html>
