
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Profile</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
    h1 { margin: 16px 0; }
    .avatar-block {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: .5rem;
      margin: 1rem 0 1.25rem;
    }
    .avatar-big {
      width: 96px; height: 96px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ddd;
      background: #f7f7f7;
    }
    .edit-avatar-btn {
      width: 32px; height: 32px;
      display: inline-flex; align-items: center; justify-content: center;
      border: 1px solid #ccc; border-radius: 6px;
      background: #fff; cursor: pointer;
      font-size: 16px;
    }
    .edit-avatar-btn:hover { background: #f2f2f2; }
    .form { margin: 12px 0 16px; display: grid; gap: 10px; max-width: 480px; }
    label { font-weight: 600; }
    input[type="text"], select {
      padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 100%;
    }
    #saveBtn { padding: 10px 14px; border: 0; border-radius: 8px; background: #2563eb; color: white; cursor: pointer; }
    #saveBtn:hover { background: #1f55c8; }
    small { opacity: .7; display: block; margin-top: 6px; }
    #profileMessage {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }
    #profileMessage.ok {
      display: block;
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    #profileMessage.error {
      display: block;
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
  </style>
</head>
<body>
  

  <h1>Update Your Profile</h1>

  <div class="avatar-block">
    <img id="avatarPreview" src="IMG/default-avatar.png" alt="Your avatar" class="avatar-big">
    <button id="editAvatarBtn" type="button" class="edit-avatar-btn" title="Change avatar">✏️</button>
    <input id="avatarFile" type="file" accept="image/*"
      style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;" />
  </div>

  <div class="form">
    <div>
      <label for="displayName">Display Name</label>
      <input id="displayName" type="text" placeholder="Enter your name" />
    </div>

    <div>
      <label for="profile-group-select">Default Group</label>
      <select id="profile-group-select">
        <option value="3159dde9-8cf3-4a29-af72-01da907f241b">Family</option>
      </select>
      <small>This selection is saved to your profile and auto-used across the app.</small>
    </div>
  </div>

<button id="saveBtn" type="button">Save Profile</button>
<div id="profileMessage" role="status" aria-live="polite"></div>

<script type="module">
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from './supabaseClient.js?v=2025.01.09E';
  import { rest, getSessionFromStorage } from './restClient.js?v=2025.01.09E';

  const defaultAvatar     = 'IMG/default-avatar.png';
  const avatarPreview     = document.getElementById('avatarPreview');
  const editAvatarBtn     = document.getElementById('editAvatarBtn');
  const avatarFile        = document.getElementById('avatarFile');
  const displayNameEl     = document.getElementById('displayName');
  const groupSelectEl     = document.getElementById('profile-group-select');
  const saveBtn           = document.getElementById('saveBtn');
  const profileMessage    = document.getElementById('profileMessage');
  let messageTimer        = null;

  const STORAGE_BUCKET    = 'avatars';
  const GROUP_KEY_ID      = 'currentGroupId';
  const GROUP_KEY_NAME    = 'currentGroupName';
  const DEMO_PROFILE      = {
    email: 'elevateanalyticstech@gmail.com',
    displayName: 'Jon Doe Star'
  };
  const FORCE_DEMO_PROFILE = true;
  const DEFAULT_GROUP     = {
    id: '3159dde9-8cf3-4a29-af72-01da907f241b',
    name: 'Family'
  };

  const SESSION_REDIRECT_DELAY = 1500;

  let session = null;
  let accessToken = null;
  let currentUser = null;
  let currentAvatarUrl = null;

  function ensureSession(redirect = true) {
    session = getSessionFromStorage();
    if (!session?.access_token || !session?.user?.id) {
      if (redirect) {
        showMessage('Session expired. Redirecting to login…', false);
        setTimeout(() => {
          window.location.href = 'login.html?redirect=profile.html';
        }, SESSION_REDIRECT_DELAY);
      }
      throw new Error('No Supabase session available');
    }
    accessToken = session.access_token;
    currentUser = session.user;
    return session;
  }

  function cacheSelectedGroup() {
    try {
      const opt = groupSelectEl.options?.[groupSelectEl.selectedIndex] || null;
      if (!opt) return;
      localStorage.setItem(GROUP_KEY_ID, opt.value || '');
      localStorage.setItem(GROUP_KEY_NAME, opt.textContent || DEFAULT_GROUP.name);
    } catch (err) {
      console.warn('[PROFILE] cacheSelectedGroup failed', err);
    }
  }

  function ensureGroupOption(id, label) {
    if (!groupSelectEl || !id) return;
    const exists = Array.from(groupSelectEl.options || []).some(opt => opt.value === id);
    if (!exists) {
      groupSelectEl.add(new Option(label || DEFAULT_GROUP.name, id));
    }
  }

  function showMessage(text, ok = true) {
    if (!profileMessage) return;
    clearTimeout(messageTimer);
    profileMessage.classList.remove('ok', 'error');
    profileMessage.classList.add(ok ? 'ok' : 'error');
    profileMessage.style.display = text ? 'block' : 'none';
    profileMessage.textContent = text || '';
    if (text) {
      profileMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
      if (!ok) {
        messageTimer = setTimeout(() => {
          profileMessage.style.display = 'none';
          profileMessage.textContent = '';
          profileMessage.classList.remove('ok', 'error');
        }, 8000);
      }
    }
  }

  async function loadGroups() {
    groupSelectEl.disabled = true;
    groupSelectEl.innerHTML = `<option value="${DEFAULT_GROUP.id}">${DEFAULT_GROUP.name}</option>`;

    let groups = [];
    try {
      ensureSession();
      const rows = await rest('groups?select=id,name,archived&order=name.asc');
      groups = (rows || []).filter(g => !g?.archived);
    } catch (err) {
      console.warn('[PROFILE] groups fetch failed; using default', err);
    }

    if (!groups.length) {
      groups = [DEFAULT_GROUP];
    }

    groupSelectEl.innerHTML = groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
    const cachedId = localStorage.getItem(GROUP_KEY_ID);
    const match = groups.find(g => g.id === cachedId);
    groupSelectEl.value = match ? match.id : groups[0].id;
    groupSelectEl.disabled = false;
    cacheSelectedGroup();
  }

  async function fetchProfile({ silent = false } = {}) {
    try {
      ensureSession();
      const metaName =
        currentUser.user_metadata?.full_name ||
        currentUser.user_metadata?.name ||
        currentUser.email ||
        '';

      displayNameEl.value = FORCE_DEMO_PROFILE ? DEMO_PROFILE.displayName : metaName;
      avatarPreview.src = defaultAvatar;
      currentAvatarUrl = null;

      const rows = await rest(
        `profiles?id=eq.${encodeURIComponent(currentUser.id)}&select=display_name,public_name,full_name,avatar_url,group_id,updated_at`
      );
      const profile = rows?.[0] || null;
      if (profile) {
        displayNameEl.value = FORCE_DEMO_PROFILE
          ? DEMO_PROFILE.displayName
          : (profile.display_name || profile.public_name || profile.full_name || metaName);
        if (profile.avatar_url) {
          avatarPreview.src = profile.avatar_url;
          currentAvatarUrl = profile.avatar_url;
        }
        if (profile.group_id) {
          ensureGroupOption(profile.group_id, groupSelectEl?.selectedOptions?.[0]?.textContent || DEFAULT_GROUP.name);
          groupSelectEl.value = profile.group_id;
          cacheSelectedGroup();
        }
        if (!silent) {
          showMessage(profile.updated_at ? `Profile loaded · ${new Date(profile.updated_at).toLocaleString()}` : 'Profile loaded ✓', true);
        }
      }
    } catch (err) {
      console.error('[PROFILE] fetchProfile failed', err);
      showMessage('Could not load profile. Try again shortly.', false);
    }
  }

  async function uploadAvatar(file) {
    if (!file) return currentAvatarUrl;
    ensureSession(false);
    const safeName = `${Date.now()}-${file.name}`.replace(/[^a-zA-Z0-9.\-_]/g, '_');
    const objectPath = `${currentUser.id}/${safeName}`;
    const storageUrl = `${SUPABASE_URL}/storage/v1/object/${STORAGE_BUCKET}/${objectPath}`;

    const response = await fetch(storageUrl, {
      method: 'POST',
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${accessToken}`,
        'x-upsert': 'true',
        'Content-Type': file.type || 'application/octet-stream'
      },
      body: file
    });

    if (!response.ok) {
      throw new Error(await response.text() || 'Avatar upload failed');
    }

    const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${STORAGE_BUCKET}/${objectPath}`;
    return publicUrl;
  }

  async function saveProfile() {
    try {
      ensureSession();
    } catch (err) {
      return;
    }

    const displayName = (displayNameEl.value || '').trim() || currentUser.email;
    const selectedGroupId = groupSelectEl.value || DEFAULT_GROUP.id;

    showMessage('Saving…', true);
    saveBtn.disabled = true;
    const originalLabel = saveBtn.textContent;
    saveBtn.textContent = 'Saving…';

    try {
      let avatarUrl = currentAvatarUrl;
      if (avatarFile.files?.length) {
        showMessage('Uploading avatar…', true);
        avatarUrl = await uploadAvatar(avatarFile.files[0]);
        currentAvatarUrl = avatarUrl;
      }

      const payload = {
        id: currentUser.id,
        display_name: displayName,
        public_name: displayName,
        full_name: displayName,
        group_id: selectedGroupId,
        updated_at: new Date().toISOString(),
        avatar_url: avatarUrl || null
      };

      const rows = await rest('profiles', {
        method: 'POST',
        headers: { Prefer: 'resolution=merge-duplicates,return=representation' },
        body: JSON.stringify([payload])
      });

      const saved = rows?.[0] || payload;
      const savedAt = saved.updated_at ? new Date(saved.updated_at).toLocaleString() : new Date().toLocaleString();
      showMessage(`Profile saved! ✅ ${savedAt}`, true);
      avatarFile.value = '';
      await fetchProfile({ silent: true });
    } catch (err) {
      console.error('[PROFILE] save failed', err);
      showMessage(err?.message || 'Could not save profile. Please try again.', false);
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = originalLabel;
    }
  }

  function triggerAvatarPicker() {
    try {
      if (typeof avatarFile.showPicker === 'function') {
        avatarFile.showPicker();
        return;
      }
    } catch (err) {
      console.warn('[PROFILE] showPicker unavailable', err);
    }
    avatarFile.click();
  }

  editAvatarBtn.addEventListener('click', (evt) => {
    evt.preventDefault();
    triggerAvatarPicker();
  });

  avatarFile.addEventListener('change', () => {
    const file = avatarFile.files?.[0];
    if (file) {
      avatarPreview.src = URL.createObjectURL(file);
    } else if (currentAvatarUrl) {
      avatarPreview.src = currentAvatarUrl;
    } else {
      avatarPreview.src = defaultAvatar;
    }
  });

  saveBtn.addEventListener('click', saveProfile);
  groupSelectEl.addEventListener('change', cacheSelectedGroup);

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      ensureSession();
      await loadGroups();
      await fetchProfile();
    } catch (err) {
      console.error('[PROFILE] init failed', err);
    }
  });
</script>
<!-- page logic(s) ... -->
<script defer src="./scripts/appbar-drawer.js?v=2025.01.09E"></script>
<script defer src="./ui-shell.js?v=2025.01.09E"></script>

<!-- Floating avatar (optional) -->
<script type="module" src="./avatar-float.js?v=2025.01.09E"></script>



</body>
</html>
